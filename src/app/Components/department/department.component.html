<app-header></app-header>
<div class="container mt-4">
  <!-- Header Section with Search and Add Button -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <input 
          type="text" 
          class="form-control" 
          placeholder="Search departments..." 
          [(ngModel)]="searchTerm"
          (keyup.enter)="search()">
        <button class="btn btn-outline-secondary" type="button" (click)="search()">
          <i class="bi bi-search"></i> Search
        </button>
        <button class="btn btn-outline-secondary" type="button" *ngIf="searchTerm" (click)="clearSearch()">
          <i class="bi bi-x"></i> Clear
        </button>
      </div>
    </div>
    <div class="col-md-6 text-end">
      <button type="button" class="btn btn-success" (click)="openCreateModal(createDepartmentModal)">
        <i class="bi bi-plus-circle"></i> Add Department
      </button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="text-center my-4" *ngIf="loading">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Table Section -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th *ngFor="let column of columnTable" (click)="sortBy(column)" style="cursor: pointer">
                {{ column | titlecase }}
                <i *ngIf="sortColumn === column" 
                   [class]="sortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'"></i>
              </th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let department of data | paginate : {itemsPerPage: itemsPerPage,currentPage: currentPage,totalItems: totalElements}">
              <td *ngFor="let column of columnTable">
                <ng-container *ngIf="column === 'branchName' && department[column] && department[column].length > 0; else regularCell">
                  <span class="badge bg-primary me-1" *ngFor="let branch of department[column]">{{ branch }}</span>
                </ng-container>
                <ng-template #regularCell>
                  {{ department[column] ? department[column] : 'N/A' }}
                </ng-template>
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary me-2" (click)="openEditModal(editDepartmentModal, department)">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="openDeleteConfirmation(deleteConfirmationModal, department.id)">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="data.length === 0 && !loading">
              <td [colSpan]="columnTable.length + 1" class="text-center py-4">
                <div class="text-muted">
                  <i class="bi bi-info-circle me-2"></i>No departments found
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white">
      <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          Showing {{ data.length ? (currentPage - 1) * itemsPerPage + 1 : 0 }} to 
          {{ calculateLastItemIndex() }} of {{ totalElements }} departments
        </div>
        <pagination-controls 
          (pageChange)="onPageChange($event)" 
          class="custom-pagination">
        </pagination-controls>
      </div>
    </div>
  </div>
</div>

<!-- Create Department Modal -->
<ng-template #createDepartmentModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Create Department</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="departmentForm">
      <!-- Department Name Input -->
      <div class="mb-3">
        <label for="departmentName" class="form-label">Department Name*</label>
        <input 
          id="departmentName" 
          formControlName="name" 
          class="form-control" 
          type="text" 
          [class.is-invalid]="isInvalid('name')" />
        <div *ngIf="isInvalid('name')" class="invalid-feedback">
          <span *ngIf="departmentForm.get('name')?.errors?.['required']">Name is required</span>
          <span *ngIf="departmentForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters</span>
        </div>
      </div>
      
      <!-- Multiple Branch Selection -->
      <div class="mb-3">
        <label for="branchName" class="form-label">Branches*</label>
        <ng-select
          [items]="branches"
          bindLabel="name"
          bindValue="name"
          [multiple]="true"
          placeholder="Select branches"
          formControlName="branchName">
        </ng-select>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-primary" [disabled]="departmentForm.invalid" (click)="submitDepartment()">Save</button>
  </div>
</ng-template>

<!-- Edit Department Modal -->
<ng-template #editDepartmentModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Edit Department</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="departmentForm">
      <!-- Department Name Input -->
      <div class="mb-3">
        <label for="editDepartmentName" class="form-label">Department Name*</label>
        <input 
          id="editDepartmentName" 
          formControlName="name" 
          class="form-control" 
          type="text" 
          [class.is-invalid]="isInvalid('name')" />
        <div *ngIf="isInvalid('name')" class="invalid-feedback">
          <span *ngIf="departmentForm.get('name')?.errors?.['required']">Name is required</span>
          <span *ngIf="departmentForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters</span>
        </div>
      </div>
      
      <!-- Multiple Branch Selection -->
      <div class="mb-3">
        <label for="editBranchNames" class="form-label">Branches*</label>
        <ng-select
          [items]="branches"
          bindLabel="name"
          bindValue="name"
          [multiple]="true"
          placeholder="Select branches"
          formControlName="branchName"
          [class.is-invalid]="isInvalid('branchNames')">
        </ng-select>
        <div *ngIf="isInvalid('branchNames')" class="invalid-feedback d-block">
          At least one branch must be selected
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-primary" [disabled]="departmentForm.invalid" (click)="updateDepartment()">Update</button>
  </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<ng-template #deleteConfirmationModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Confirm Delete</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to delete this department? This action cannot be undone.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="deleteDepartment()">Delete</button>
  </div>
</ng-template>