<app-header></app-header>
<div class="container mt-4">
  <!-- Header Section with Search and Add Button -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <input 
          type="text" 
          class="form-control" 
          placeholder="Search branches..." 
          [(ngModel)]="searchTerm"
          (keyup.enter)="search()">
        <button class="btn btn-outline-secondary" type="button" (click)="search()">
          <i class="bi bi-search"></i> Search
        </button>
        <button class="btn btn-outline-secondary" type="button" *ngIf="searchTerm" (click)="clearSearch()">
          <i class="bi bi-x"></i> Clear
        </button>
      </div>
    </div>
    <div class="col-md-6 text-end">
      <button type="button" class="btn btn-success" (click)="openCreateModal(createBranchModal)">
        <i class="bi bi-plus-circle"></i> Add Branch
      </button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="text-center my-4" *ngIf="loading">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Table Section -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th *ngFor="let column of columnTable" (click)="sortBy(column)" style="cursor: pointer">
                {{ column | titlecase }}
                <i *ngIf="sortColumn === column" 
                   [class]="sortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'"></i>
              </th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let branch of data | paginate : {itemsPerPage: itemsPerPage,currentPage: currentPage,totalItems: totalElements}">
              <td *ngFor="let column of columnTable">
                <!-- {{ branch[column] }} -->
                <ng-container *ngIf="column === 'departmentName' && branch[column] && branch[column].length > 0; else regularCell">
                  <span class="badge bg-primary me-1" *ngFor="let branch of branch[column]">{{ branch }}</span>
                </ng-container>
                <ng-template #regularCell>
                  {{ branch[column] ? branch[column] : 'N/A' }}
                </ng-template>
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary me-2" (click)="openEditModal(editBranchModal, branch)">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="openDeleteConfirmation(deleteConfirmationModal, branch.id)">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="data.length === 0 && !loading">
              <td [colSpan]="columnTable.length + 1" class="text-center py-4">
                <div class="text-muted">
                  <i class="bi bi-info-circle me-2"></i>No branches found
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white">
      <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          Showing {{ data.length ? (currentPage - 1) * itemsPerPage + 1 : 0 }} to 
          {{ calculateLastItemIndex() }} of {{ totalElements }} branches
        </div>
        <pagination-controls 
          (pageChange)="onPageChange($event)" 
          class="custom-pagination">
        </pagination-controls>
      </div>
    </div>
  </div>
</div>

<!-- Create Branch Modal -->
<ng-template #createBranchModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Create Branch</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="branchForm">
      <!-- Branch Name Input -->
      <div class="mb-3">
        <label for="branchName" class="form-label">Branch Name*</label>
        <input 
          id="branchName" 
          formControlName="name" 
          class="form-control" 
          type="text" 
          [class.is-invalid]="isInvalid('name')" />
        <div *ngIf="isInvalid('name')" class="invalid-feedback">
          <span *ngIf="branchForm.get('name')?.errors?.['required']">Name is required</span>
          <span *ngIf="branchForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters</span>
        </div>
      </div>
      
      <!-- Branch Address Input -->
      <div class="mb-3">
        <label for="branchAddress" class="form-label">Address*</label>
        <input 
          id="branchAddress" 
          formControlName="address" 
          class="form-control" 
          type="text" 
          [class.is-invalid]="isInvalid('address')" />
        <div *ngIf="isInvalid('address')" class="invalid-feedback">
          Address is required
        </div>
      </div>
      
      <!-- Branch Phone Input -->
      <div class="mb-3">
        <label for="branchPhone" class="form-label">Phone*</label>
        <input 
          id="branchPhone" 
          formControlName="phone" 
          class="form-control" 
          type="text" 
          [class.is-invalid]="isInvalid('phone')" />
        <div *ngIf="isInvalid('phone')" class="invalid-feedback">
          <span *ngIf="branchForm.get('phone')?.errors?.['required']">Phone is required</span>
          <span *ngIf="branchForm.get('phone')?.errors?.['pattern']">Please enter a valid phone number</span>
        </div>
      </div>
      <!-- Multiple Department Selection -->
      <div class="mb-3">
        <label for="branchDepartmentname" class="form-label">Department</label>
        <ng-select
          [items]="departments"
          bindLabel="name"
          bindValue="name"
          [multiple]="true"
          placeholder="Select Departments"
          formControlName="departmentName">
        </ng-select>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-primary" [disabled]="branchForm.invalid" (click)="submitBranch()">Save</button>
  </div>
</ng-template>

<!-- Edit Branch Modal -->
<ng-template #editBranchModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Create Branch</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="branchForm">
      <!-- Branch Name Input -->
      <div class="mb-3">
        <label for="branchName" class="form-label">Branch Name*</label>
        <input 
          id="branchName" 
          formControlName="name" 
          class="form-control" 
          type="text" 
          [class.is-invalid]="isInvalid('name')" />
        <div *ngIf="isInvalid('name')" class="invalid-feedback">
          <span *ngIf="branchForm.get('name')?.errors?.['required']">Name is required</span>
          <span *ngIf="branchForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters</span>
        </div>
      </div>
      
      <!-- Branch Address Input -->
      <div class="mb-3">
        <label for="branchAddress" class="form-label">Address*</label>
        <input 
          id="branchAddress" 
          formControlName="address" 
          class="form-control" 
          type="text" 
          [class.is-invalid]="isInvalid('address')" />
        <div *ngIf="isInvalid('address')" class="invalid-feedback">
          Address is required
        </div>
      </div>
      
      <!-- Branch Phone Input -->
      <div class="mb-3">
        <label for="branchPhone" class="form-label">Phone*</label>
        <input 
          id="branchPhone" 
          formControlName="phone" 
          class="form-control" 
          type="text" 
          [class.is-invalid]="isInvalid('phone')" />
        <div *ngIf="isInvalid('phone')" class="invalid-feedback">
          <span *ngIf="branchForm.get('phone')?.errors?.['required']">Phone is required</span>
          <span *ngIf="branchForm.get('phone')?.errors?.['pattern']">Please enter a valid phone number</span>
        </div>
      </div>
      <!-- Multiple Department Selection -->
      <div class="mb-3">
        <label for="branchDepartmentName" class="form-label">Department</label>
        <ng-select
          [items]="departments"
          bindLabel="name"
          bindValue="name"
          [multiple]="true"
          placeholder="Select Departments"
          formControlName="departmentName">
        </ng-select>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-primary" [disabled]="branchForm.invalid" (click)="updateBranch()">Save</button>
  </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<ng-template #deleteConfirmationModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Confirm Delete</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to delete this branch? This action cannot be undone.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="deleteBranch()">Delete</button>
  </div>
</ng-template>