<div class="container-fluid py-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6 col-xl-5">
        <div class="card shadow-lg border-0 rounded-4">
          <div class="card-body p-4 p-md-5">
             <!-- Close Button (Visible only when called as a modal) -->
          <div class="d-flex justify-content-between ">
            <h2 class="card-title text-center align-items-center mb-4 fw-bold">{{ formHeader }}</h2>
            <button *ngIf="showCloseButton" class="btn-close" (click)="close()"></button>
          </div>
            
            <!-- Registration Progress -->
            <div class="mb-4" *ngIf="registerForm.get('roleName')?.value">
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-primary" role="progressbar" 
                     [style.width]="calculateProgress() + '%'" 
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <div class="d-flex justify-content-between mt-1">
                <small class="text-muted">Select Role</small>
                <small class="text-muted">Basic Info</small>
                <small class="text-muted">Complete</small>
              </div>
            </div>
  
            <!-- Alert for errors -->
            <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              {{ errorMessage }}
              <button type="button" class="btn-close" (click)="errorMessage = null"></button>
            </div>
  
            <form *ngIf="registerForm" [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="needs-validation">
              <!-- Role Selection Card -->
              <div class="mb-4">
                <label class="form-label fw-medium">I am a:</label>
                <div class="d-flex gap-2 mb-3">
                  <div *ngFor="let role of roles" class="flex-grow-1">
                    <input type="radio" class="btn-check" [value]="role.value" formControlName="roleName" 
                           [id]="'btn-role-' + role.value">
                    <label class="btn btn-outline-primary w-100 position-relative rounded-3 d-flex flex-column align-items-center py-3" 
                           [for]="'btn-role-' + role.value">
                      <i class="bi" [ngClass]="getIconForRole(role.value)"></i>
                      <span class="mt-2">{{ role.label }}</span>
                    </label>
                  </div>
                </div>
              </div>
  
              <!-- Dynamic Fields -->
              <div class="row g-3">
                <div *ngFor="let key of roleFields[registerForm.get('roleName')?.value]" 
                     [ngClass]="getColumnClass(key)" class="mb-3">
                  <label class="form-label fw-medium">
                    {{ getLabelName(key) }}
                    <span *ngIf="isFieldRequired(key)" class="text-danger">*</span>
                  </label>
                  
                  <!-- Select Input -->
                  <div *ngIf="fieldConfig[key].type === 'select'" class="input-group">
                    <span class="input-group-text bg-light border-end-0">
                      <i class="bi" [ngClass]="getIconForField(key)"></i>
                    </span>
                    <select class="form-select border-start-0" [formControlName]="key"
                            [ngClass]="{'is-invalid': isFieldInvalid(key)}">
                      <option value="">{{ fieldConfig[key].placeholder }}</option>
                      <option *ngFor="let option of fieldConfig[key].options" [value]="option">{{ option }}</option>
                    </select>
                    <div *ngIf="isFieldInvalid(key)" class="invalid-feedback">
                      <span *ngFor="let error of getFieldErrors(key)">{{ error }}</span>
                    </div>
                  </div>
                  
                  <!-- Other Input Types -->
                  <div *ngIf="fieldConfig[key].type !== 'select'" class="input-group">
                    <span class="input-group-text bg-light border-end-0">
                      <i class="bi" [ngClass]="getIconForField(key)"></i>
                    </span>
                    <input [type]="fieldConfig[key].type" class="form-control border-start-0"
                           [formControlName]="key" [placeholder]="fieldConfig[key].placeholder"
                           [ngClass]="{'is-invalid': isFieldInvalid(key)}">
                    <div *ngIf="isFieldInvalid(key)" class="invalid-feedback">
                      <span *ngFor="let error of getFieldErrors(key)">{{ error }}</span>
                    </div>
                  </div>
                </div>
              </div>
  
              <!-- Action Buttons -->
              <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary py-2 fw-medium" [disabled]="registerForm.invalid || isLoading">
                  <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  <i *ngIf="!isLoading" class="bi bi-person-plus-fill me-2"></i>
                  {{!showCloseButton?'Create Account':'Add User'}}
                </button>
                <div *ngIf="!showCloseButton" class="text-center mt-3">
                  <p class="mb-0">Already have an account?
                    <a routerLink="/login" class="fw-medium text-decoration-none">Sign In</a>
                  </p>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>